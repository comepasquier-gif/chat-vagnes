<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Chat Chavagnes</title>
<meta name="theme-color" content="#0ea5a4">
<style>
body {
  margin:0;
  font-family: 'Arial', sans-serif;
  background: url('https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcT5_2q9CKo6j52ret7quZBcpcC7tCxn7zNdfw&s') no-repeat center center fixed;
  background-size: cover;
  color:#fff;
  height:100vh;
  display:flex;
  justify-content:center;
  align-items:center;
}
#login, #chat {
  display:none;
  flex-direction:column;
  width:100%;
  max-width:500px;
  height:100%;
  background:rgba(0,0,0,0.5);
}
#login {
  display:flex;
  justify-content:center;
  align-items:center;
  gap:10px;
}
#login input, #login button {
  padding:10px;
  border:none;
  border-radius:6px;
}
header, footer {
  padding:10px;
  background: rgba(11,18,32,0.8);
  display:flex;
  align-items:center;
  gap:8px;
}
main {
  flex:1;
  overflow:auto;
  padding:10px;
  background: rgba(0,0,0,0.2);
  border-top:2px solid #0ea5a4;
  border-bottom:2px solid #0ea5a4;
}
input, button {
  padding:8px;
  border-radius:6px;
  border:none;
}
input { flex:1; }
button {
  background:#0ea5a4;
  color:#022;
  cursor:pointer;
}
.msg{
  padding:6px 10px;
  border-radius:8px;
  margin:4px 0;
  max-width:70%;
  display:inline-block;
}
.mine{background:#0ea5a4;color:#022;margin-left:auto;}
.other{background:#1e293b;}
.meta{font-size:11px;color:#94a3b8;margin-top:3px;}
.adminTag {
  background:#facc15;
  color:#222;
  padding:2px 4px;
  border-radius:4px;
  font-size:11px;
  margin-left:4px;
}
</style>
</head>
<body>

<!-- ðŸ”¹ Login screen -->
<div id="login">
  <div style="text-align:center">
    <h2>ðŸ”’ Connexion au chat</h2>
    <p>Entre ton code d'accÃ¨s :</p>
    <input id="codeInput" type="text" placeholder="Code">
    <button onclick="checkCode()">Entrer</button>
    <p id="loginError" style="color:red;"></p>
  </div>
</div>

<!-- ðŸ”¹ Chat screen -->
<div id="chat">
  <header>
    <input id="nick" type="text" placeholder="Pseudo" value="User">
  </header>

  <main id="messages"></main>

  <footer>
    <input id="inputMsg" type="text" placeholder="Ton message...">
    <button id="sendBtn">Envoyer</button>
  </footer>
</div>

<!-- âœ… Firebase SDK en compat -->
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>

<script>
// ðŸ”¹ Config Firebase
const firebaseConfig = {
  apiKey: "AIzaSyDP-H6X01nM42PGb1Wym7RCaWrsugrL5vA",
  authDomain: "minichat-fc8fc.firebaseapp.com",
  databaseURL: "https://minichat-fc8fc-default-rtdb.europe-west1.firebasedatabase.app/",
  projectId: "minichat-fc8fc",
  storageBucket: "minichat-fc8fc.firebasestorage.app",
  messagingSenderId: "614755534085",
  appId: "1:614755534085:web:3dd7799d11f5991c69236c"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.database();

const loginEl = document.getElementById("login");
const chatEl = document.getElementById("chat");
const codeInput = document.getElementById("codeInput");
const loginError = document.getElementById("loginError");

const msgEl = document.getElementById("messages");
const nickEl = document.getElementById("nick");
const inputMsg = document.getElementById("inputMsg");
const sendBtn = document.getElementById("sendBtn");

let isAdmin = false;
let loggedIn = false;

// ðŸ”¹ VÃ©rifier le code utilisateur
function checkCode(){
  const code = codeInput.value.trim();
  if(!code) return;

  db.ref("codes/" + code).once("value").then(snap=>{
    if(snap.exists()){
      loggedIn = true;
      loginEl.style.display = "none";
      chatEl.style.display = "flex";
      startChat();
    } else {
      loginError.innerText = "â›” Code invalide";
    }
  });
}

// ðŸ”¹ Envoi de message
function sendMessage(){
  if(!loggedIn) return;
  const text = inputMsg.value.trim();
  if(!text) return;

  // Commandes admin
  if(text === "/code adminlesang"){
    isAdmin = true;
    alert("âœ… Tu es maintenant ADMIN !");
    inputMsg.value="";
    return;
  }

  if(text.startsWith("/new user ")){
    if(isAdmin){
      const newCode = text.split(" ")[2];
      if(newCode){
        db.ref("codes/"+newCode).set(true).then(()=>{
          alert("ðŸ”‘ Nouveau code crÃ©Ã©: "+newCode);
        });
      }
    } else {
      alert("â›” Seul un admin peut crÃ©er des codes !");
    }
    inputMsg.value="";
    return;
  }

  if(text === "/clear"){
    if(isAdmin){
      db.ref("messages").remove();
      msgEl.innerHTML = "";
      alert("ðŸ§¹ Messages supprimÃ©s !");
    } else {
      alert("â›” Seul un admin peut vider le chat !");
    }
    inputMsg.value="";
    return;
  }

  // Envoi normal
  const nick = nickEl.value || "Anonyme";
  db.ref("messages").push({
    nick,
    text,
    admin: isAdmin,
    t: Date.now()
  });
  inputMsg.value="";
}

sendBtn.onclick = sendMessage;
inputMsg.addEventListener("keydown", e => { if(e.key==="Enter") sendMessage() });

// ðŸ”¹ Lancement du chat (Ã©coute des messages)
function startChat(){
  db.ref("messages").on("child_added", snap => {
    const m = snap.val();
    const div = document.createElement("div");
    const me = (m.nick === nickEl.value);
    div.className = "msg " + (me ? "mine" : "other");
    let adminTag = m.admin ? `<span class="adminTag">[Admin]</span>` : "";
    div.innerHTML = `<strong>${m.nick}${adminTag}:</strong> ${m.text}
                     <div class="meta">${new Date(m.t).toLocaleTimeString()}</div>`;
    msgEl.appendChild(div);
    msgEl.scrollTop = msgEl.scrollHeight;
  });
}
</script>
</body>
</html>
