<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>MiniChat SuperAdmin</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0; padding: 0;
      display: flex; flex-direction: column;
      height: 100vh;
      background: #ece5dd;
    }
    header {
      background: #075e54; color: white;
      padding: 10px; text-align: center;
    }
    #messages {
      flex: 1; overflow-y: auto; padding: 10px;
      display: flex; flex-direction: column;
    }
    .msg {
      padding: 8px 12px; margin: 5px;
      border-radius: 10px; max-width: 70%;
    }
    .mine { background: #dcf8c6; align-self: flex-end; }
    .other { background: #fff; align-self: flex-start; }
    .system { background: #ffd; font-style: italic; text-align: center; }
    #controls {
      display: flex; padding: 10px; background: #f0f0f0;
    }
    #controls input { flex: 1; padding: 8px; }
    #controls button { padding: 8px; margin-left: 5px; }
    #login {
      position: absolute; top:0; left:0; right:0; bottom:0;
      background: rgba(0,0,0,0.8);
      color: white; display: flex;
      align-items: center; justify-content: center;
      flex-direction: column;
    }
    #login input { margin: 5px; padding: 8px; }
  </style>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
</head>
<body>
  <header>ðŸ’¬ MiniChat avec Super-Admin</header>
  <div id="messages"></div>
  <div id="controls">
    <input id="inputMsg" placeholder="Ã‰crire un message..." />
    <button onclick="sendMessage()">Envoyer</button>
  </div>

  <div id="login">
    <h2>Connexion</h2>
    <input id="nick" placeholder="Pseudo"/>
    <input id="code" placeholder="Code d'accÃ¨s"/>
    <button onclick="login()">Se connecter</button>
  </div>

<script>
  // ðŸ”¹ Config Firebase
  const firebaseConfig = {
    apiKey: "AIzaSyDP-H6X01nM42PGb1Wym7RCaWrsugrL5vA",
    authDomain: "minichat-fc8fc.firebaseapp.com",
    projectId: "minichat-fc8fc",
    storageBucket: "minichat-fc8fc.firebasestorage.app",
    messagingSenderId: "614755534085",
    appId: "1:614755534085:web:3dd7799d11f5991c69236c",
    databaseURL: "https://minichat-fc8fc-default-rtdb.europe-west1.firebasedatabase.app/"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  const msgEl = document.getElementById("messages");
  const inputMsg = document.getElementById("inputMsg");
  const loginBox = document.getElementById("login");
  const nickEl = document.getElementById("nick");
  const codeEl = document.getElementById("code");

  let loggedIn = false;
  let isAdmin = false;
  let isSuperAdmin = false;
  const SUPER_CODE = "supercode123"; // ðŸ”‘ Code secret super admin

  // ðŸ”¹ Commandes disponibles
  const commands = [
    { cmd: "/code adminlesang", role: "user", desc: "Devenir admin" },
    { cmd: "/new user <code>", role: "admin", desc: "CrÃ©er un nouveau code d'accÃ¨s" },
    { cmd: "/clear", role: "admin", desc: "Supprimer tous les messages" },
    { cmd: "/super <code>", role: "user", desc: "Devenir super-admin (code secret)" },
    { cmd: "/recup", role: "super", desc: "RÃ©cupÃ©rer et nettoyer la base" },
    { cmd: "/reset", role: "super", desc: "RÃ©initialiser complÃ¨tement la base" },
    { cmd: "/help", role: "user", desc: "Afficher les commandes (alias /)" }
  ];

  function systemMessage(txt){
    let d=document.createElement("div");
    d.className="msg system";
    d.innerText=txt;
    msgEl.appendChild(d);
    msgEl.scrollTop=msgEl.scrollHeight;
  }

  function login(){
    const nick=nickEl.value.trim();
    const code=codeEl.value.trim();
    if(!nick || !code) return alert("Pseudo + code requis !");
    db.ref("codes/"+code).once("value").then(snap=>{
      if(snap.exists() || code==="0000"){
        loggedIn=true;
        loginBox.style.display="none";
        listenMessages();
      } else {
        alert("Code invalide !");
      }
    });
  }

  function sendMessage(){
    if(!loggedIn) return;
    const text=inputMsg.value.trim();
    if(!text) return;

    // --- Commandes ---
    if(text === "/code adminlesang"){
      isAdmin=true;
      systemMessage("âœ… Tu es maintenant ADMIN !");
      inputMsg.value=""; return;
    }

    if(text.startsWith("/new user ")){
      if(isAdmin || isSuperAdmin){
        const newCode = text.split(" ")[2];
        if(newCode){
          db.ref("codes/"+newCode).set(true).then(()=>{
            systemMessage("ðŸ”‘ Nouveau code crÃ©Ã©: "+newCode);
          });
        }
      } else systemMessage("â›” Seul un admin peut crÃ©er des codes !");
      inputMsg.value=""; return;
    }

    if(text === "/clear"){
      if(isAdmin || isSuperAdmin){
        db.ref("messages").remove();
        msgEl.innerHTML="";
        systemMessage("ðŸ§¹ Messages supprimÃ©s !");
      } else systemMessage("â›” Seul un admin peut vider le chat !");
      inputMsg.value=""; return;
    }

    if(text.startsWith("/super ")){
      const code=text.split(" ")[1];
      if(code===SUPER_CODE){
        isSuperAdmin=true;
        isAdmin=true;
        systemMessage("ðŸ‘‘ Tu es maintenant SUPER ADMIN !");
      } else {
        systemMessage("â›” Code super-admin incorrect !");
      }
      inputMsg.value=""; return;
    }

    if(text === "/recup"){
      if(isSuperAdmin){
        db.ref("messages").once("value").then(snap=>{
          const messages=snap.val();
          if(messages){
            const dataStr="data:text/json;charset=utf-8,"+encodeURIComponent(JSON.stringify(messages));
            const dl=document.createElement("a");
            dl.setAttribute("href",dataStr);
            dl.setAttribute("download","backup_chat.json");
            dl.click();
            systemMessage("ðŸ“¥ Sauvegarde tÃ©lÃ©chargÃ©e !");
          }
          // puis nettoyage
          db.ref("messages").remove();
          msgEl.innerHTML="";
          systemMessage("ðŸ§¹ Base nettoyÃ©e (sauf sauvegarde tÃ©lÃ©chargÃ©e).");
        });
      } else systemMessage("â›” Seul le super-admin peut utiliser /recup !");
      inputMsg.value=""; return;
    }

    if(text === "/reset"){
      if(isSuperAdmin){
        db.ref("messages").remove().then(()=>{
          msgEl.innerHTML="";
          systemMessage("âš¡ Reset complet effectuÃ© par le SUPER ADMIN !");
        });
      } else systemMessage("â›” Seul le super-admin peut reset !");
      inputMsg.value=""; return;
    }

    // ðŸ”¹ Aide
    if(text==="/" || text==="/help" || text.startsWith("/")){
      let filter=(text==="/"||text==="/help")?"":text;
      let available=commands.filter(c=>{
        if(filter && !c.cmd.startsWith(filter)) return false;
        if(c.role==="admin" && !isAdmin && !isSuperAdmin) return false;
        if(c.role==="super" && !isSuperAdmin) return false;
        return true;
      });
      if(available.length>0){
        available.forEach(c=>systemMessage(c.cmd+" â†’ "+c.desc));
      } else {
        systemMessage("âŒ Aucune commande trouvÃ©e pour '"+filter+"'");
      }
      inputMsg.value=""; return;
    }

    // --- Envoi normal ---
    const nick=nickEl.value||"Anonyme";
    db.ref("messages").push({nick,text,t:Date.now()});
    inputMsg.value="";
  }

  function listenMessages(){
    db.ref("messages").on("child_added", snap=>{
      const m=snap.val();
      let d=document.createElement("div");
      d.className="msg "+(m.nick===nickEl.value?"mine":"other");
      d.innerText=m.nick+": "+m.text;
      msgEl.appendChild(d);
      msgEl.scrollTop=msgEl.scrollHeight;
    });
  }
</script>
</body>
</html>
