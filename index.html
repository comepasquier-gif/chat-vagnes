<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Mini WhatsApp</title>
<meta name="theme-color" content="#25D366">
<style>
body {
  margin:0;
  font-family: 'Arial', sans-serif;
  background:#ece5dd;
  height:100vh;
  display:flex;
  justify-content:center;
  align-items:center;
}
#login, #chat {
  display:none;
  flex-direction:column;
  width:100%;
  max-width:600px;
  height:100%;
  background:#fff;
  border:1px solid #ccc;
}
#login {
  display:flex;
  justify-content:center;
  align-items:center;
  gap:10px;
}
#login input, #login button {
  padding:10px;
  border:none;
  border-radius:6px;
}
header {
  padding:10px;
  background:#075E54;
  color:#fff;
  font-weight:bold;
  text-align:center;
}
main {
  flex:1;
  overflow:auto;
  padding:10px;
  background:#e5ddd5;
  display:flex;
  flex-direction:column;
}
footer {
  display:flex;
  gap:5px;
  padding:8px;
  background:#f0f0f0;
}
input, button {
  padding:8px;
  border-radius:20px;
  border:none;
}
input { flex:1; padding-left:15px;}
button {
  background:#25D366;
  color:#fff;
  cursor:pointer;
}
.msg{
  padding:10px 14px;
  border-radius:18px;
  margin:6px 0;
  max-width:70%;
  font-size:14px;
  position:relative;
}
.mine{background:#dcf8c6; align-self:flex-end;}
.other{background:#fff; align-self:flex-start;}
.meta{font-size:11px;color:#555;margin-top:3px;text-align:right;}
.adminTag {
  background:#FFD700;
  color:#000;
  padding:2px 6px;
  border-radius:8px;
  font-size:10px;
  margin-left:5px;
}
</style>
</head>
<body>

<!-- ðŸ”¹ Login -->
<div id="login">
  <div style="text-align:center">
    <h2>ðŸ”’ Connexion</h2>
    <p>Entre ton code d'accÃ¨s :</p>
    <input id="codeInput" type="text" placeholder="Code">
    <button onclick="checkCode()">Entrer</button>
    <p id="loginError" style="color:red;"></p>
  </div>
</div>

<!-- ðŸ”¹ Chat -->
<div id="chat">
  <header>ðŸ’¬ Mini WhatsApp</header>
  <main id="messages"></main>
  <footer>
    <input id="nick" type="text" placeholder="Pseudo" value="User">
    <input id="inputMsg" type="text" placeholder="Ton message...">
    <button id="sendBtn">âž¤</button>
  </footer>
</div>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>

<script>
// ðŸ”¹ Config Firebase
const firebaseConfig = {
  apiKey: "AIzaSyDP-H6X01nM42PGb1Wym7RCaWrsugrL5vA",
  authDomain: "minichat-fc8fc.firebaseapp.com",
  databaseURL: "https://minichat-fc8fc-default-rtdb.europe-west1.firebasedatabase.app/",
  projectId: "minichat-fc8fc",
  storageBucket: "minichat-fc8fc.firebasestorage.app",
  messagingSenderId: "614755534085",
  appId: "1:614755534085:web:3dd7799d11f5991c69236c"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.database();

const loginEl = document.getElementById("login");
const chatEl = document.getElementById("chat");
const codeInput = document.getElementById("codeInput");
const loginError = document.getElementById("loginError");

const msgEl = document.getElementById("messages");
const nickEl = document.getElementById("nick");
const inputMsg = document.getElementById("inputMsg");
const sendBtn = document.getElementById("sendBtn");

let isAdmin = false;
let loggedIn = false;

// âœ… Ajouter un code de base "0000"
db.ref("codes/0000").once("value").then(snap=>{
  if(!snap.exists()){
    db.ref("codes/0000").set(true);
  }
});

// ðŸ”¹ VÃ©rifier le code utilisateur
function checkCode(){
  const code = codeInput.value.trim();
  if(!code) return;
  db.ref("codes/" + code).once("value").then(snap=>{
    if(snap.exists()){
      loggedIn = true;
      loginEl.style.display = "none";
      chatEl.style.display = "flex";
      startChat();
    } else {
      loginError.innerText = "â›” Code invalide";
    }
  });
}

// ðŸ”¹ Envoi de message
function sendMessage(){
  if(!loggedIn) return;
  const text = inputMsg.value.trim();
  if(!text) return;

  // Commandes admin
  if(text === "/code adminlesang"){
    isAdmin = true;
    alert("âœ… Tu es maintenant ADMIN !");
    inputMsg.value="";
    return;
  }

  if(text.startsWith("/new user ")){
    if(isAdmin){
      const newCode = text.split(" ")[2];
      if(newCode){
        db.ref("codes/"+newCode).set(true).then(()=>{
          alert("ðŸ”‘ Nouveau code crÃ©Ã©: "+newCode);
        });
      }
    } else {
      alert("â›” Seul un admin peut crÃ©er des codes !");
    }
    inputMsg.value="";
    return;
  }

  if(text === "/clear"){
    if(isAdmin){
      db.ref("messages").remove();
      msgEl.innerHTML = "";
      alert("ðŸ§¹ Messages supprimÃ©s !");
    } else {
      alert("â›” Seul un admin peut vider le chat !");
    }
    inputMsg.value="";
    return;
  }

  // Envoi normal
  const nick = nickEl.value || "Anonyme";
  db.ref("messages").push({
    nick,
    text,
    admin: isAdmin,
    t: Date.now()
  }).then(()=>{

    // âœ… Garder seulement les 10 derniers
    db.ref("messages").once("value").then(snap=>{
      const messages = snap.val();
      if(messages){
        const keys = Object.keys(messages);
        if(keys.length > 10){
          const toDelete = keys.slice(0, keys.length - 10);
          toDelete.forEach(k => db.ref("messages/"+k).remove());
        }
      }
    });

    inputMsg.value="";
  });
}

sendBtn.onclick = sendMessage;
inputMsg.addEventListener("keydown", e => { if(e.key==="Enter") sendMessage() });

// ðŸ”¹ Lecture des messages
function startChat(){
  db.ref("messages").on("child_added", snap => {
    const m = snap.val();
    const div = document.createElement("div");
    const me = (m.nick === nickEl.value);
    div.className = "msg " + (me ? "mine" : "other");
    let adminTag = m.admin ? `<span class="adminTag">Admin</span>` : "";
    div.innerHTML = `${m.text}
                     <div class="meta">${m.nick} ${adminTag} â€¢ ${new Date(m.t).toLocaleTimeString()}</div>`;
    msgEl.appendChild(div);
    msgEl.scrollTop = msgEl.scrollHeight;
  });
}
</script>
</body>
</html>
